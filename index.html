<!DOCTYPE html>
<html>
 <head>
   <!-- Select2 CSS -->
   <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


   <style>
     body { font-family: Arial, sans-serif; padding: 20px; background-color: #f9f9f9; }
     h3 { color: #2c3e50; text-align: center; }
     label { margin-top: 10px; font-weight: bold; color: #34495e; }
     select, input { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
     button { margin-top: 15px; padding: 10px; width: 48%; border: none; border-radius: 8px; color: white; background-color: #3498db; cursor: pointer; }
     button:hover { background-color: #2980b9; }
     .btn-group { display: flex; justify-content: space-between; }
     #error { color: red; margin-top: 10px; text-align: center; }
     .select2-container--default .select2-selection--single { height: 42px; border-radius: 8px; border: 1px solid #ccc; padding: 5px; }
   </style>
 </head>


 <body>
   <h3>Mouvement Stock</h3>


   <!-- Sélecteur Type sans appel à resetLotFields() -->
   <label>Type :</label>
   <select id="type" onchange="renderLotField();">
     <option value="">-- Choisir --</option>
     <option value="Entrée">Entrée</option>
     <option value="Sortie">Sortie</option>
   </select>


   <label>Catégorie :</label>
   <select id="category" onchange="loadArticles()">
     <option value="">-- Choisir --</option>
   </select>


   <label>Article :</label>
   <select id="article" onchange="handleArticleChange()">
     <option value="">-- Choisir --</option>
   </select>


   <label>Quantité :</label>
   <input type="number" id="quantity" min="1" />


   <label>Lot :</label>
   <div id="lot-container">
     <!-- Le champ Lot sera créé dynamiquement -->
   </div>


   <label>Date de Péremption :</label>
   <input type="date" id="peremption" />


   <label>Responsable :</label>
   <select id="responsable">
     <option value="">-- Choisir --</option>
   </select>


   <div class="btn-group">
     <button onclick="submitForm()">Valider</button>
     <button onclick="resetForm()" style="background-color:#e74c3c;">Effacer</button>
   </div>


   <div id="error"></div>
   <div id="processing" style="color: green; text-align: center; margin-top: 10px; display: none;">
     Traitement en cours...
   </div>


   <script>
     let allArticles = [];


     // Charger catégories + articles
     google.script.run.withSuccessHandler(function(data) {
       allArticles = data;
       var categories = [...new Set(allArticles.map(a => a[0]))];
       var selectCat = document.getElementById('category');
       selectCat.innerHTML = '<option value="">-- Choisir --</option>';
       categories.forEach(function(c) {
         var option = document.createElement('option');
         option.text = c;
         option.value = c;
         selectCat.add(option);
       });
     }).getAllArticlesWithCategories();


     // Charger responsables
     google.script.run.withSuccessHandler(function(responsables) {
       var select = document.getElementById('responsable');
       select.innerHTML = '<option value="">-- Choisir --</option>';
       responsables.forEach(function(r) {
         var option = document.createElement('option');
         option.text = r;
         option.value = r;
         select.add(option);
       });
     }).getResponsables();


     function loadArticles() {
       var category = document.getElementById('category').value;
       var select = document.getElementById('article');
       select.innerHTML = '<option value="">-- Choisir --</option>';


       if (category) {
         var filtered = allArticles.filter(a => a[0] === category);
         filtered.sort((a, b) => a[1].localeCompare(b[1]));
         filtered.forEach(function(a) {
           var option = document.createElement('option');
           option.text = a[1];
           option.value = a[1];
           select.add(option);
         });


         $(document).ready(function(){
           $('#article').select2({
             width: '100%',
             placeholder: "-- Choisir --",
             allowClear: true
           });
         });
       } else {
         $('#article').empty().trigger('change');
         $('#article').select2('destroy');
       }
     }


     function renderLotField() {
       var type = document.getElementById('type').value;
       var lotContainer = document.getElementById('lot-container');
       lotContainer.innerHTML = '';


       if (type === 'Entrée') {
         var input = document.createElement('input');
         input.type = "text";
         input.id = "lotInput";
         input.placeholder = "Saisir lot";
         input.style.width = "100%";
         input.style.padding = "10px";
         input.style.marginTop = "5px";
         input.style.border = "1px solid #ccc";
         input.style.borderRadius = "8px";
         lotContainer.appendChild(input);
       } else if (type === 'Sortie') {
         var select = document.createElement('select');
         select.id = "lotSelect";
         select.innerHTML = '<option value="">-- Choisir --</option>';
         select.style.width = "100%";
         select.style.padding = "10px";
         select.style.marginTop = "5px";
         select.style.border = "1px solid #ccc";
         select.style.borderRadius = "8px";
         lotContainer.appendChild(select);
       }
     }


     function handleArticleChange() {
       var type = document.getElementById('type').value;
       var article = document.getElementById('article').value;


       if (type === "Sortie" && article) {
         google.script.run.withSuccessHandler(function(lots) {
           var lotSelect = document.getElementById('lotSelect');
           lotSelect.innerHTML = '<option value="">-- Choisir --</option>';
           lots.forEach(function(l) {
             var option = document.createElement('option');
             option.text = l.lot + " (Péremption : " + l.peremptionFormatted + ")";
             option.value = l.lot;
             lotSelect.add(option);
           });
         }).getAvailableLots(article);
       }
     }


     function resetLotFields() {
       document.getElementById('lot-container').innerHTML = '';
     }


     function submitForm() {
       var type = document.getElementById('type').value;
       var category = document.getElementById('category').value;
       var article = document.getElementById('article').value;
       var quantity = parseInt(document.getElementById('quantity').value);
       var lot = '';
       if (type === 'Entrée') {
         lot = document.getElementById('lotInput').value;
       } else if (type === 'Sortie') {
         lot = document.getElementById('lotSelect').value;
       }
       var peremption = document.getElementById('peremption').value;
       var responsable = document.getElementById('responsable').value;
       var error = document.getElementById('error');
       error.innerText = '';


       if (!type || !category || !article || !responsable || !quantity || quantity <= 0 || !lot || !peremption) {
         error.innerText = "Veuillez remplir tous les champs correctement.";
         return;
       }


       const buttons = document.querySelectorAll("button");
       buttons.forEach(btn => btn.disabled = true);
       document.getElementById('processing').style.display = 'block';


       var entry = {
         type: type,
         category: category,
         article: article,
         quantity: quantity,
         responsable: responsable,
         lot: lot,
         peremption: peremption
       };
fetch("https://script.google.com/macros/s/AKfycbyND9s8_54-6WB2e6WOSDnygyXNukS4FyKkLLmfohEapPeK6AuVxRIbUwHdZlkg-v73/exec", {

 
  method: "POST",
  body: JSON.stringify({
    article: document.getElementById("article").value,
    quantite: document.getElementById("quantite").value
  }),
  headers: {
    "Content-Type": "application/json"
  }
})
.then(res => res.text())
.then(msg => alert("Réponse serveur : " + msg))
.catch(err => alert("Erreur : " + err));


       // Appel à la fonction serveur updateStockWithLot avec gestion du succès et de l'échec
       google.script.run
         .withSuccessHandler(() => {
           resetForm();
           alert("Entrée prise en compte");
         })
         .withFailureHandler((err) => {
           document.getElementById('processing').style.display = 'none';
           document.getElementById('error').innerText = "Erreur lors de l'enregistrement : " + err.message;
           const buttons = document.querySelectorAll("button");
           buttons.forEach(btn => btn.disabled = false);
         })
         .updateStockWithLot(entry);
     }


     function resetForm() {
       // Masquer le message "Traitement en cours"
       document.getElementById('processing').style.display = 'none';
       document.getElementById('type').value = '';
       document.getElementById('category').value = '';
       document.getElementById('article').innerHTML = '<option value="">-- Choisir --</option>';
       document.getElementById('quantity').value = '';
       document.getElementById('peremption').value = '';
       document.getElementById('responsable').value = '';
       document.getElementById('error').innerText = '';
       $('#article').select2('destroy');
       renderLotField();
     }

     document.addEventListener("DOMContentLoaded", function() {
  const peremptionInput = document.getElementById("peremption");

  // Dès que l'utilisateur change la date → elle est forcée comme validée
  peremptionInput.addEventListener("change", function() {
    peremptionInput.blur(); // simule un "perte de focus" pour forcer la prise en compte
  });
});

   </script>
 </body>
</html>




